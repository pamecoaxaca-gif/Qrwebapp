<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>QR con logo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Arial; max-width:500px; margin:40px auto; padding:0 16px; }
    h1 { margin-bottom:4px; }
    label { display:block; margin:10px 0 4px; font-weight:600; }
    input, button { width:100%; padding:10px; font-size:1rem; border:1px solid #ccc; border-radius:6px; }
    button { background:#2563EB; color:#fff; border:none; cursor:pointer; margin-top:12px; }
    #canvasWrapper { position:relative; width:250px; height:250px; margin:20px auto; }
    canvas { width:250px; height:250px; display:block; }
    #logoPreview { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:60px; height:60px; pointer-events:none; border-radius:8px; }
    .info { background:#f1f5f9; padding:8px; border-radius:6px; margin-top:8px; }
  </style>
</head>
<body>
  <h1>Generador de QR con logo</h1>
  <p>Coloca tu URL, sube el logo y dale a generar. Luego descarga el QR.</p>

  <label for="url">URL de tu webapp</label>
  <input id="url" type="text" placeholder="https://script.google.com/macros/s/.../exec" value="https://script.google.com/macros/s/AKfycbyCk25PkcKEfU3cDelv2TG4s2KvXftGE4ez2i02UYRYnWLffB7TvkwrvpPysBCijV48/exec" />

  <label for="logo">Logo (arr치stralo o selecci칩nalo)</label>
  <input id="logo" type="file" accept="image/*" />

  <button onclick="generar()">Generar QR</button>

  <div id="canvasWrapper">
    <canvas id="qrcanvas" width="500" height="500"></canvas>
    <img id="logoPreview" src="" alt="logo" />
  </div>

  <div class="info" id="linkDisplay"></div>
  <button onclick="descargar()" style="margin-top:8px;">Descargar PNG</button>

  <script>
    let logoImg = null;

    document.getElementById('logo').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        logoImg = new Image();
        logoImg.onload = () => {
          document.getElementById('logoPreview').src = ev.target.result;
        };
        logoImg.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });

    async function generar() {
      const url = document.getElementById('url').value.trim();
      if (!url) {
        alert("Pon la URL.");
        return;
      }
      document.getElementById('linkDisplay').innerHTML = `<div><strong>Enlace:</strong> <code>${url}</code></div>`;
      const canvas = document.getElementById('qrcanvas');
      const size = 500;
      canvas.width = size;
      canvas.height = size;
      // generar QR en canvas temporario
      await QRCode.toCanvas(canvas, url, { width: size, margin:1, errorCorrectionLevel: 'H' });
      if (logoImg) {
        const ctx = canvas.getContext('2d');
        // dibujar logo en el centro, ocupando ~20% del QR
        const logoSize = size * 0.2;
        const x = (size - logoSize) / 2;
        const y = (size - logoSize) / 2;
        // agregar fondo blanco redondeado detr치s del logo para contraste
        const radius = 12;
        ctx.fillStyle = '#fff';
        roundRect(ctx, x - 6, y - 6, logoSize + 12, logoSize + 12, 12);
        ctx.fill();
        ctx.drawImage(logoImg, x, y, logoSize, logoSize);
      }
    }

    // dibuja rect치ngulo redondeado
    function roundRect(ctx, x, y, w, h, r) {
      ctx.beginPath();
      ctx.moveTo(x + r, y);
      ctx.lineTo(x + w - r, y);
      ctx.quadraticCurveTo(x + w, y, x + w, y + r);
      ctx.lineTo(x + w, y + h - r);
      ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
      ctx.lineTo(x + r, y + h);
      ctx.quadraticCurveTo(x, y + h, x, y + h - r);
      ctx.lineTo(x, y + r);
      ctx.quadraticCurveTo(x, y, x + r, y);
      ctx.closePath();
    }

    function descargar() {
      const canvas = document.getElementById('qrcanvas');
      const link = document.createElement('a');
      link.download = 'qr_evidencia.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    }
  </script>
</body>
</html>
